# Changelog

## [Unreleased] - 2025-01-XX

### üö® Hotfixes (Post-Review)

#### Fixed analytics closing Mini App instantly
- **Problem**: `analytics.track()` –≤—ã–∑—ã–≤–∞–ª `window.Telegram.WebApp.sendData()`, —á—Ç–æ –ø–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ Telegram —Å—Ä–∞–∑—É –∑–∞–∫—Ä—ã–≤–∞–µ—Ç WebApp. `trackSessionStart()` –∑–∞–∫—Ä—ã–≤–∞–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
- **Solution**: –£–±—Ä–∞–Ω –≤—ã–∑–æ–≤ `sendData()`, –æ—Å—Ç–∞–≤–ª–µ–Ω–æ —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Å–æ–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ. –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø—Ä–æ –±–∞—Ç—á–µ–≤—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —á–µ—Ä–µ–∑ API –≤ –±—É–¥—É—â–µ–º
- **Impact**: Mini App —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ–±—ã—Ç–∏–π
- **Files**: `apps/web/lib/analytics.ts`

#### Fixed case-sensitive search returning no results
- **Problem**: –ó–∞–ø—Ä–æ—Å –ø—Ä–∏–≤–æ–¥–∏–ª—Å—è –∫ `.toLowerCase()`, –Ω–æ Notion `rich_text.contains` —Ä–µ–≥–∏—Å—Ç—Ä–æ–∑–∞–≤–∏—Å–∏–º—ã–π. –ü–æ–∏—Å–∫ "–ú–æ—Å–∫–≤–∞" –Ω–µ –Ω–∞—Ö–æ–¥–∏–ª "–º–æ—Å–∫–≤–∞"
- **Solution**: –£–±—Ä–∞–Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ lowercase, –ø–æ–∏—Å–∫ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø—Ä–æ case-insensitive –≤–∞—Ä–∏–∞–Ω—Ç—ã
- **Impact**: –ü–æ–∏—Å–∫ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è –≥–æ—Ä–æ–¥–æ–≤ —Å –∑–∞–≥–ª–∞–≤–Ω–æ–π –±—É–∫–≤—ã
- **Files**: `src/notion/listings.repo.ts`

### üêõ Critical Fixes

#### Fixed location fields being erased on profile save
- **Problem**: –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—è `city` –∏ `country` —Å—Ç–∏—Ä–∞–ª–∏—Å—å, —Ç–∞–∫ –∫–∞–∫ —Ñ–æ—Ä–º–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∞ –∑–Ω–∞—á–µ–Ω–∏–µ `location` –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- **Solution**: 
  - –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è "–ì–æ—Ä–æ–¥" –∏ "–°—Ç—Ä–∞–Ω–∞" –≤ —Ñ–æ—Ä–º—É –ø—Ä–æ—Ñ–∏–ª—è (`ProfileForm.tsx`)
  - `buildProfilePayload` —Ç–µ–ø–µ—Ä—å —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç `location` –∏–∑ `city` –∏ `country`
  - –ó–Ω–∞—á–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- **Impact**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ–ª—å—à–µ –Ω–µ –ø–æ—Ç–µ—Ä—è—é—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏

### üîß Medium Fixes

#### Separated preview and publish loading states
- **Problem**: –û–¥–∏–Ω —Ñ–ª–∞–≥ `listingLoading` —É–ø—Ä–∞–≤–ª—è–ª –∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º, –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π ‚Äî –∫–Ω–æ–ø–∫–∞ "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å" –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞ "–ü—É–±–ª–∏–∫—É–µ–º‚Ä¶" –¥–∞–∂–µ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
- **Solution**: 
  - –†–∞–∑–¥–µ–ª–µ–Ω—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–∞ `listingPreviewing` –∏ `listingPublishing`
  - –ö–∞–∂–¥–∞—è –∫–Ω–æ–ø–∫–∞ —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
  - –£–ª—É—á—à–µ–Ω–∞ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π
- **Impact**: –ë–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω—ã–π UX, —Ç–æ—á–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞

#### Bot profile caching in middleware
- **Problem**: –ö–∞–∂–¥–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ `/menu`, "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "‚ÑπÔ∏è –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å" –≤—ã–∑—ã–≤–∞–ª–æ –∑–∞–ø—Ä–æ—Å –∫ Notion
- **Solution**: 
  - –î–æ–±–∞–≤–ª–µ–Ω middleware –≤ `router.ts`, –∫–æ—Ç–æ—Ä—ã–π –∫–µ—à–∏—Ä—É–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –≤ `ctx.state.profile`
  - –ö–æ–º–∞–Ω–¥—ã —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å
  - –°–Ω–∏–∂–µ–Ω–∞ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ Notion API
- **Impact**: –ë—ã—Å—Ç—Ä–µ–µ –æ—Ç–∫–ª–∏–∫ –±–æ—Ç–∞, –º–µ–Ω—å—à–µ –ª–∏–º–∏—Ç–æ–≤ API

### ‚ú® New Features

#### Search functionality (/search + inline query)
- **Added `/search` command** –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –ø–æ –≥–æ—Ä–æ–¥—É –∏–ª–∏ —Å—Ç—Ä–∞–Ω–µ
- **Inline query support** ‚Äî –º–æ–∂–Ω–æ –∏—Å–∫–∞—Ç—å –ø—Ä—è–º–æ –≤ —á–∞—Ç–µ: `@bot_name –ë–∞—Ä—Å–µ–ª–æ–Ω–∞`
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–æ 20 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–æ–¥–µ–ª–∏—Ç—å—Å—è
- –ü–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–º –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º
- **Files changed**: 
  - `src/notion/listings.repo.ts` ‚Äî –º–µ—Ç–æ–¥ `searchPublished()`
  - `src/services/listing.service.ts` ‚Äî –º–µ—Ç–æ–¥ `search()`
  - `src/telegram/commands.ts` ‚Äî –∫–æ–º–∞–Ω–¥–∞ –∏ inline handler
  - `src/core/config.ts` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–æ `channelUsername`

#### Draft functionality with localStorage
- **Auto-save drafts** ‚Äî —Ñ–æ—Ä–º–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
- **Auto-load on startup** ‚Äî —á–µ—Ä–Ω–æ–≤–∏–∫ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏, –µ—Å–ª–∏ –∞–Ω–∫–µ—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞
- **TTL 7 days** ‚Äî —á–µ—Ä–Ω–æ–≤–∏–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è 7 –¥–Ω–µ–π
- –í–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "üìù –ß–µ—Ä–Ω–æ–≤–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω"
- –ß–µ—Ä–Ω–æ–≤–∏–∫ —É–¥–∞–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
- **Files changed**: 
  - `apps/web/lib/drafts.ts` (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)
  - `apps/web/app/twa/page.tsx` ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

#### Ability to delete listings
- –ö–Ω–æ–ø–∫–∞ "üóëÔ∏è –£–¥–∞–ª–∏—Ç—å" –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –≤ —Å–ø–∏—Å–∫–µ "–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è"
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
- –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Notion (–Ω–µ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ)
- **Files changed**: 
  - `src/notion/listings.repo.ts` ‚Äî –º–µ—Ç–æ–¥ `archive()`
  - `src/services/listing.service.ts` ‚Äî –º–µ—Ç–æ–¥ `archive()`
  - `src/api/routes/listings.ts` ‚Äî DELETE endpoint
  - `apps/web/lib/api.ts` ‚Äî –º–µ—Ç–æ–¥ `deleteListing()`
  - `apps/web/app/twa/page.tsx` ‚Äî UI –∫–Ω–æ–ø–∫–∞

#### Custom React hooks
–î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –∫–æ–¥–∞ –∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏:
- **`useTelegramSession`** ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram session, –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
- **`useListings`** ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–º –æ–±—ä—è–≤–ª–µ–Ω–∏–π
- –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –¥—Ä—É–≥–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
- **Files**: 
  - `apps/web/hooks/useTelegramSession.ts`
  - `apps/web/hooks/useListings.ts`

#### Event tracking (analytics)
- –¢—Ä–µ–∫–∏–Ω–≥ –∫–ª—é—á–µ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
  - `session_start` ‚Äî –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  - `profile_save`, `profile_publish` ‚Äî —Ä–∞–±–æ—Ç–∞ —Å –∞–Ω–∫–µ—Ç–æ–π
  - `listing_preview`, `listing_publish`, `listing_delete` ‚Äî —Ä–∞–±–æ—Ç–∞ —Å –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º–∏
  - `photo_upload` ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ
  - `draft_save`, `draft_load` ‚Äî —Ä–∞–±–æ—Ç–∞ —Å —á–µ—Ä–Ω–æ–≤–∏–∫–∞–º–∏
  - `error_occurred` ‚Äî –æ—à–∏–±–∫–∏
- –õ–µ–≥–∫–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏ (Google Analytics, Mixpanel)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- **Files**: 
  - `apps/web/lib/analytics.ts` (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)
  - `apps/web/app/twa/page.tsx` ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ç—Ä–µ–∫–∏–Ω–≥–∞

### üìù Configuration

–î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è):
```env
CHANNEL_USERNAME=your_channel_username
```
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–æ–∫ –Ω–∞ –ø–æ—Å—Ç—ã –≤ –∫–∞–Ω–∞–ª–µ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ.

### üîÆ Future Enhancements (–û—Ç–ª–æ–∂–µ–Ω–æ)

#### `/notify` command (subscription management)
- **–°—Ç–∞—Ç—É—Å**: –û—Ç–ª–æ–∂–µ–Ω–æ –¥–ª—è –±—É–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏
- **–û–ø–∏—Å–∞–Ω–∏–µ**: –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –Ω–∞ –Ω–æ–≤—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø–æ –≥–æ—Ä–æ–¥–∞–º/—Å—Ç—Ä–∞–Ω–∞–º
- **–ü—Ä–∏—á–∏–Ω–∞**: –¢—Ä–µ–±—É–µ—Ç –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —Å —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø–æ–¥–ø–∏—Å–æ–∫ –∏ —Ñ–æ–Ω–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é

1. –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: `npm install`
2. –î–æ–±–∞–≤–∏—Ç—å `CHANNEL_USERNAME` –≤ `.env` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
3. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç: `npm run build`
4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è —Å –≥–æ—Ä–æ–¥–æ–º/—Å—Ç—Ä–∞–Ω–æ–π
- ‚úÖ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏–π (–æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã)
- ‚úÖ `/search` –∫–æ–º–∞–Ω–¥–∞ –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ —Å –≥–æ—Ä–æ–¥–æ–º
- ‚úÖ Inline query –ø–æ–∏—Å–∫
- ‚úÖ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤
- ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
- ‚úÖ –°–æ–±—ã—Ç–∏—è –≤ console (analytics)

## Known Issues

–ù–µ—Ç –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º.

## Contributors

- AI Assistant (@cursor)

